<!doctype html>
<html>
<head>
    <meta charset="utf-8">
	<title>Spotify Playlist Manager</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
	<style type="text/css">
		.hidden {
			display:none;
		}
		.page-content {
			margin-top:51px;
			padding-top:25px;
		}
		.table>thead>tr>th, 
		.table>tbody>tr>th, 
		.table>tfoot>tr>th, 
		.table>thead>tr>td, 
		.table>tbody>tr>td, 
		.table>tfoot>tr>td {
			vertical-align:middle;
		}
	</style>
</head>
<body>

    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <span class="navbar-brand">Spotify Playlist Manager</span>
        </div>
      </div>
    </nav>
	
	<div class="container page-content">
		<div id="spotifyLogin" class="hidden">
			<div class="jumbotron">
				<h1>Please login to Spotify to continue</h1>
				<p><a class="btn btn-lg btn-primary" href="spotifyLogin" role="button">Login</a></p>
			</div>	
		</div>
		<div id="loading" class="hidden">
			<div class="jumbotron">
				<h1>Loading playlists ...</h1>
			</div>	
		</div>
		<table id="playlists" class="table table-striped hidden">
			<tbody>
				<tr>
					<th>Name</th>
					<th class="text-center">Copy to Deezer</th>
				</tr>
			</tbody>
		</table>
	</div>
	
	<script id="playlist-template" type="text/x-handlebars-template">
		<td>{{name}}</td>
		<td class="text-center">
			<button aria-label="Copy to Deezer" data-playlist-id="{{id}}">
				<span class="glyphicon glyphicon-export">
				</span>
			</button>
		</td>
    </script>
	
	<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0/handlebars.min.js"></script>
    <script>
		(function() {
			
			var params = getHashParams();

			var spotifyAccessToken = tryGetParam('spotify_access_token', params),
				spotifyRefreshToken = tryGetParam('spotify_refresh_token', params),
				spotifyUserId = tryGetParam('spotify_user_id', params),
				deezerAccessToken = tryGetParam('deezer_access_token', params),
				deezerUserId = tryGetParam('deezer_user_id', params),
				error = params.error;
				
			if (error) {
				alert(error);
				return;
			}
			
			if (spotifyAccessToken === null || spotifyUserId === null) {
				document.getElementById('spotifyLogin').classList.remove('hidden');
				return;
			}

			loadPlaylists(spotifyUserId, spotifyAccessToken);
			
			/**
			* Obtains parameters from the hash of the URL
			* @return Object
			*/
			function getHashParams() {
			
				var hashParams = {};
				var e,
					r = /([^&;=]+)=?([^&;]*)/g,
					q = window.location.hash.substring(1);
				while ( e = r.exec(q)) {
					hashParams[e[1]] = decodeURIComponent(e[2]);
				}
				return hashParams;
			}
			
			function tryGetParam(paramName, queryStringParams) {
				
				var value = queryStringParams[paramName];
				
				if (typeof value === "undefined" || value === '') {
					value = sessionStorage.getItem(paramName);
				}
				else {
					sessionStorage.setItem(paramName, value);
				}
				
				return value;
			}
			
			function loadPlaylists(spotifyUserId, spotifyAccessToken) {
				
				document.getElementById('loading').classList.remove('hidden');
			
				var playlistsUrl = 'https://api.spotify.com/v1/users/' + encodeURIComponent(spotifyUserId) + '/playlists'
				$.ajax({
					type: 'GET',
					url: playlistsUrl,
					headers: {
						'Authorization': 'Bearer ' + spotifyAccessToken
					},
					success: displayPlaylists,
					error: ajaxError,
				});
			}
			
			function displayPlaylists(playlistsRepsonse) {
			
				var playlistTemplateSource = document.getElementById('playlist-template').innerHTML,
					playlistTemplate = Handlebars.compile(playlistTemplateSource),
					playlistsTable = document.getElementById('playlists');
				
				playlistsRepsonse.items.forEach(function(currentValue, index, array) {
					
					var playlistMarkup = playlistTemplate(currentValue);
					var row = playlistsTable.insertRow();
					row.innerHTML = playlistMarkup;
				});

				document.getElementById('loading').classList.add('hidden');
				
				playlistsTable.addEventListener('click', onPlaylistTableClick);
				playlistsTable.classList.remove('hidden');
			}
			
			function onPlaylistTableClick(event) {
			
				var buttonElement;
				
				if (event.target.hasAttribute('data-playlist-id')) {
					buttonElement = event.target;
				}
				else if (typeof event.target.parent != "undefined" && event.target.parent.hasAttribute('data-playlist-id')) {
					buttonElement = event.target.parent;
				}
				
				if (typeof buttonElement != "undefined") {
							
					if (deezerAccessToken === null || deezerUserId === null) {
						document.location.href = '/deezerLogin';
						return;
					}
				
					var playlistId = event.target.getAttribute('data-playlist-id');
					copyPlaylistToDeezer(playlistId);
				}
			}
			
			
			
			function ajaxError(jqXHR, textStatus, errorThrown) {
				
				var ajaxError = {
					textStatus: textStatus,
					errorThrown: errorThrown,
				};
				console.error(ajaxError);
			}
			
			function copyPlaylistToDeezer(playlistId) {
				var playlistTracksUrl = 'https://api.spotify.com/v1/users/' + encodeURIComponent(userId) + '/playlists/' + encodeURIComponent(playlistId) + '/tracks'
				$.ajax({
					type: 'GET',
					url: playlistTracksUrl,
					headers: {
						'Authorization': 'Bearer ' + accessToken
					},
					success: function(response) {
					
						var deezerTracks = new Array(response.items.length);
						
						response.items.forEach(function(currentValue, index, array) {
							findTrackInDeezer(currentValue.track.name, currentValue.track.album.name, currentValue.track.artists[0].name);
						});
						
						
					},
					error: ajaxError,
				});
			}
			
			function findTrackInDeezer(trackName, albumName, artistName) {
			
				var queryString = trackName + ' ' + artistName;
				var deezerTrackSearchUrl = 'http://api.deezer.com/search/track?q=' + encodeURIComponent(queryString) + '&output=jsonp';
				$.ajax({
					type: 'GET',
					url: deezerTrackSearchUrl,
                    dataType: 'jsonp',
					success: function(response) {
					
						var deezerTrackId;
					
						response.data.forEach(function(currentValue, index, array) {
							if (currentValue.title === trackName &&
								currentValue.album.title === albumName &&
								currentValue.artist.name === artistName) {
								
								deezerTrackId = currentValue.id;
								return true;
							}
							
							return false;
						});
						
						if (typeof deezerTrackId != "undefined") {
							
						}
						
					},
					error: ajaxError,
				});
			}
      })();
    </script>
</body>
</html>