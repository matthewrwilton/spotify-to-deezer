<!doctype html>
<html>
<head>
    <meta charset="utf-8">
	<title>Spotify Playlist Manager</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
	<style type="text/css">
		.hidden {
			display:none;
		}
		.page-content {
			margin-top:51px;
			padding-top:25px;
		}
		.table>thead>tr>th, 
		.table>tbody>tr>th, 
		.table>tfoot>tr>th, 
		.table>thead>tr>td, 
		.table>tbody>tr>td, 
		.table>tfoot>tr>td {
			vertical-align:middle;
		}
	</style>
</head>
<body>

    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <span class="navbar-brand">Spotify Playlist Manager</span>
        </div>
      </div>
    </nav>
	
	<div class="container page-content">
		<div id="login" class="hidden">
			<div class="jumbotron">
				<h1>Please login to Spotify to continue</h1>
				<p><a class="btn btn-lg btn-primary" href="login" role="button">Login</a></p>
			</div>	
		</div>
		<div id="loading" class="hidden">
			<div class="jumbotron">
				<h1>Loading playlists ...</h1>
			</div>	
		</div>
		<table id="playlists" class="table table-striped hidden">
			<tbody>
				<tr>
					<th>Name</th>
					<th class="text-center">Copy to Deezer</th>
				</tr>
			</tbody>
		</table>
	</div>
	
	<script id="playlist-template" type="text/x-handlebars-template">
		<td>{{name}}</td>
		<td class="text-center">
			<button aria-label="Copy to Deezer">
				<span class="glyphicon glyphicon-export">
				</span>
			</button>
		</td>
    </script>
	
	<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0/handlebars.min.js"></script>
    <script>
		(function() {

			/**
			* Obtains parameters from the hash of the URL
			* @return Object
			*/
			function getHashParams() {
			
				var hashParams = {};
				var e,
					r = /([^&;=]+)=?([^&;]*)/g,
					q = window.location.hash.substring(1);
				while ( e = r.exec(q)) {
					hashParams[e[1]] = decodeURIComponent(e[2]);
				}
				return hashParams;
			}
			
			function ajaxError(jqXHR, textStatus, errorThrown) {
				
				alert('AJAX error');
			}
			
			var playlistTemplateSource = document.getElementById('playlist-template').innerHTML,
				playlistTemplate = Handlebars.compile(playlistTemplateSource),
				playlistsTable = document.getElementById('playlists');
			
			function displayPlaylists(userId, accessToken) {
				
				var playlistsUrl = 'https://api.spotify.com/v1/users/' + userId + '/playlists'
				$.ajax({
					type: 'GET',
					url: playlistsUrl,
					headers: {
						'Authorization': 'Bearer ' + accessToken
					},
					success: function(response) {
					
						response.items.forEach(function(currentValue, index, array) {
							
							var playlistMarkup = playlistTemplate(currentValue);
							var row = playlistsTable.insertRow();
							row.innerHTML = playlistMarkup;
						});

						document.getElementById('loading').classList.add('hidden');
						document.getElementById('playlists').classList.remove('hidden');
					},
					error: ajaxError,
				});
			}

			var params = getHashParams();

			var accessToken = params.access_token,
				userId = params.user_id,
				error = params.error;

			if (error) {
				alert('There was an error during the authentication');
				document.getElementById('login').classList.remove('hidden');
				return;
			}
			
			if (!accessToken || !userId) {
				document.getElementById('login').classList.remove('hidden');
				return;
			}

			document.getElementById('loading').classList.remove('hidden');
			displayPlaylists(userId, accessToken);
      })();
    </script>
</body>
</html>